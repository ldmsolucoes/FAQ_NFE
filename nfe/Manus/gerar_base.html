<div style="max-width: 800px; margin: 20px auto; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
  <h2 style="color: #153A6B; margin-top: 0;">Gerar/Atualizar Base de Conhecimentos NFE</h2>
  
  <div id="status-container" style="margin-bottom: 20px;">
    <h3>Status da Base Atual:</h3>
    <div id="status-info" style="padding: 10px; background: #f9f9f9; border-radius: 4px;">
      Carregando status...
    </div>
  </div>
  
  <div style="margin-bottom: 20px;">
    <p>Esta função irá:</p>
    <ul>
      <li>Verificar se existe uma base de dados ChromaDB</li>
      <li>Criar uma nova base se não existir</li>
      <li>Buscar informações atualizadas sobre erros NFE em fontes oficiais</li>
      <li>Atualizar a base de conhecimentos com novas informações</li>
    </ul>
  </div>
  
  <div style="margin-bottom: 20px;">
    <button 
      id="gerar-base-btn"
      style="padding: 12px 24px; background: #153A6B; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px;"
    >Gerar/Atualizar Base</button>
    
    <button 
      id="verificar-status-btn"
      style="padding: 12px 24px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; margin-left: 10px;"
    >Verificar Status</button>
  </div>
  
  <div id="progress-container" style="display: none; margin-bottom: 20px;">
    <h3>Progresso:</h3>
    <div style="width: 100%; background-color: #f0f0f0; border-radius: 4px;">
      <div id="progress-bar" style="width: 0%; height: 20px; background-color: #153A6B; border-radius: 4px; transition: width 0.3s;"></div>
    </div>
    <div id="progress-text" style="margin-top: 10px; font-style: italic;">Iniciando...</div>
  </div>
  
  <div id="result-container" style="display: none;">
    <h3>Resultado:</h3>
    <div id="result-content" style="padding: 15px; background: #f9f9f9; border-radius: 4px; white-space: pre-wrap; max-height: 400px; overflow-y: auto;"></div>
  </div>
</div>

<script>
// Carregar status inicial
async function carregarStatus() {
  try {
    const response = await fetch('/status_base');
    const data = await response.json();
    
    const statusDiv = document.getElementById('status-info');
    if (data.status === 'sucesso') {
      statusDiv.innerHTML = `
        <strong>Base encontrada!</strong><br>
        Total de documentos: ${data.total_documents}<br>
        Coleção: ${data.collection_name}<br>
        Caminho: ${data.db_path}
      `;
      statusDiv.style.background = '#d4edda';
      statusDiv.style.color = '#155724';
    } else {
      statusDiv.innerHTML = `
        <strong>Base não encontrada</strong><br>
        ${data.message}<br>
        <em>Uma nova base será criada ao executar a atualização.</em>
      `;
      statusDiv.style.background = '#fff3cd';
      statusDiv.style.color = '#856404';
    }
  } catch (error) {
    document.getElementById('status-info').innerHTML = 'Erro ao carregar status: ' + error.message;
  }
}

// Gerar/atualizar base
async function gerarBase() {
  const btn = document.getElementById('gerar-base-btn');
  const progressContainer = document.getElementById('progress-container');
  const resultContainer = document.getElementById('result-container');
  const progressBar = document.getElementById('progress-bar');
  const progressText = document.getElementById('progress-text');
  const resultContent = document.getElementById('result-content');
  
  // Desabilitar botão e mostrar progresso
  btn.disabled = true;
  btn.textContent = 'Processando...';
  progressContainer.style.display = 'block';
  resultContainer.style.display = 'none';
  
  // Simular progresso
  let progress = 0;
  const progressInterval = setInterval(() => {
    progress += Math.random() * 10;
    if (progress > 90) progress = 90;
    progressBar.style.width = progress + '%';
    progressText.textContent = `Processando... ${Math.round(progress)}%`;
  }, 500);
  
  try {
    const response = await fetch('/gerar_base_conhecimento', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({})
    });
    
    const data = await response.json();
    
    // Finalizar progresso
    clearInterval(progressInterval);
    progressBar.style.width = '100%';
    progressText.textContent = 'Concluído!';
    
    // Mostrar resultado
    resultContainer.style.display = 'block';
    resultContent.textContent = JSON.stringify(data, null, 2);
    
    // Recarregar status
    setTimeout(carregarStatus, 1000);
    
  } catch (error) {
    clearInterval(progressInterval);
    resultContainer.style.display = 'block';
    resultContent.textContent = 'Erro: ' + error.message;
  } finally {
    btn.disabled = false;
    btn.textContent = 'Gerar/Atualizar Base';
  }
}

// Event listeners
document.getElementById('gerar-base-btn').addEventListener('click', gerarBase);
document.getElementById('verificar-status-btn').addEventListener('click', carregarStatus);

// Carregar status inicial
carregarStatus();
</script>

